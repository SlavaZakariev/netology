## 21.3 Микросервисы: подходы - Вячеслав Закариев

Вы работаете в крупной компании, которая строит систему на основе микросервисной архитектуры. \
Вам как DevOps-специалисту необходимо выдвинуть предложение по организации инфраструктуры для разработки и эксплуатации.

### Задача 1: Обеспечить разработку

Предложите решение для обеспечения процесса разработки: хранение исходного кода, непрерывная интеграция и поставка. \
Решение может состоять из одного или нескольких программных продуктов и должно описывать принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- облачная система;
- система контроля версий Git;
- репозиторий на каждый сервис;
- запуск сборки по событию из системы контроля версий;
- запуск сборки по кнопке с указанием параметров;
- возможность привязать настройки к каждой сборке;
- возможность создания шаблонов для различных конфигураций сборок;
- возможность безопасного хранения секретных данных (пароли, ключи доступа);
- несколько конфигураций для сборки из одного репозитория;
- кастомные шаги при сборке;
- собственные докер-образы для сборки проектов;
- возможность развернуть агентов сборки на собственных серверах;
- возможность параллельного запуска нескольких сборок;
- возможность параллельного запуска тестов.

Обоснуйте свой выбор.

---

### Решение 1

На сегодняшний день есть программное обеспечение GitLab, которое можно использовать как в облаке так и на собственных мощностях. Gitlab от других аналогов отличает то, что можно собрать все требуемые для микросервисной архитектуры функции в единой точке. Другими словами:

1) `Git` - Разбить репозитории на каждый микросервис для dev и для prod по отдельной ветке
2) `Users` - Можно всем участникам разработки создать учётные записи и выделить права на каждый сервис по отдельности
3) `CI\CD` - Построить конвеер для каждого микросервиса как для dev так и для prod
4) `Deployment` - Разворачивание конвееров позволяет проводить тестирование перед сборкой
5) `Vars` - У GitLab есть список встроенных переменных, который позволяет не выставлять чувствительные данные в открытую
6) `Docker Registry` - GitLab поддерживает своё собственное хранилище контейнеров
7) `Runners` - Развернуть два независимых агентах раннера для dev сервисов и отдельно для prod сервисов
8) `Lan` - Развернуть для dev сегмента отдельную подсеть, так же и для prod, чтобы инфраструктурные площадки не пересекались

---

### Задача 2: Логи

Предложите решение для обеспечения сбора и анализа логов сервисов в микросервисной архитектуре. \
Решение может состоять из одного или нескольких программных продуктов и должно описывать принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- сбор логов в центральное хранилище со всех хостов, обслуживающих систему;
- минимальные требования к приложениям, сбор логов из stdout;
- гарантированная доставка логов до центрального хранилища;
- обеспечение поиска и фильтрации по записям логов;
- обеспечение пользовательского интерфейса с функцией предоставления доступа разработчикам для поиска по записям логов;
- возможность дать ссылку на сохранённый поиск по записям логов.

Обоснуйте свой выбор.

---

### Решение 2

Для сбора логов на сегодня популярным является стэк ELK, но хочу остановить на продукрте Grafana-Loki \
Поднять отдельный сервер Linux и настроить хранилище сбора логов:

1) `Универнальный ресурс сбора` - Принимает журналы в любом формате, из любого источника, используя широкий спектр клиентов
2) `Гибкий подход к сбору` - Loki использует уникальный подход, индексируя только метаданные, а не полный текст строк журнала
3) `Высокоскоростное хранилище` - Большой и долговечный объём хранилища логов, а также высокая пропускная способность
4) `Генерация оповещения` - На основе строк журнала, можно создавать показатели и генерировать оповещения
5) `Онлайн журналирование` - Отслеживает журналы по мере их поступления в систему, можно просматривать журналы за нужную дату
6) `Универсальная интеграция` - Можно интегрировать с Prometheus, Grafana и K8s
7) `LogQL` - Собственный язык запросов для более детального изучения журналов. Для целителей командной строки есть LogCLI.

---

### Задача 3: Мониторинг

Предложите решение для обеспечения сбора и анализа состояния хостов и сервисов в микросервисной архитектуре. \
Решение может состоять из одного или нескольких программных продуктов и должно описывать принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- сбор метрик со всех хостов, обслуживающих систему;
- сбор метрик состояния ресурсов хостов: CPU, RAM, HDD, Network;
- сбор метрик потребляемых ресурсов для каждого сервиса: CPU, RAM, HDD, Network;
- сбор метрик, специфичных для каждого сервиса;
- пользовательский интерфейс с возможностью делать запросы и агрегировать информацию;
- пользовательский интерфейс с возможностью настраивать различные панели для отслеживания состояния системы.

Обоснуйте свой выбор.

---
