## 20.1 Системы мониторинга - Вячеслав Закариев

### Обязательные задания

1. Вас пригласили настроить мониторинг на проект. На онбординге вам рассказали, что проект представляет из себя 
платформу для вычислений с выдачей текстовых отчетов, которые сохраняются на диск. Взаимодействие с платформой 
осуществляется по протоколу http. Также вам отметили, что вычисления загружают ЦПУ. Какой минимальный набор метрик вы
выведите в мониторинг и почему?
#
2. Менеджер продукта посмотрев на ваши метрики сказал, что ему непонятно что такое RAM/inodes/CPUla. Также он сказал, 
что хочет понимать, насколько мы выполняем свои обязанности перед клиентами и какое качество обслуживания. Что вы 
можете ему предложить?
#
3. Вашей DevOps команде в этом году не выделили финансирование на построение системы сбора логов. Разработчики в свою 
очередь хотят видеть все ошибки, которые выдают их приложения. Какое решение вы можете предпринять в этой ситуации, 
чтобы разработчики получали ошибки приложения?
#
4. Вы, как опытный SRE, сделали мониторинг, куда вывели отображения выполнения SLA=99% по http кодам ответов. 
Вычисляете этот параметр по следующей формуле: summ_2xx_requests/summ_all_requests. Данный параметр не поднимается выше 
70%, но при этом в вашей системе нет кодов ответа 5xx и 4xx. Где у вас ошибка?
#
5. Опишите основные плюсы и минусы pull и push систем мониторинга.
#
6. Какие из ниже перечисленных систем относятся к push модели, а какие к pull? А может есть гибридные?

    - Prometheus 
    - TICK
    - Zabbix
    - VictoriaMetrics
    - Nagios
#
7. Склонируйте себе [репозиторий](https://github.com/influxdata/sandbox/tree/master) и запустите TICK-стэк, 
используя технологии docker и docker-compose.

В виде решения на это упражнение приведите скриншот веб-интерфейса ПО chronograf (`http://localhost:8888`). 

P.S.: если при запуске некоторые контейнеры будут падать с ошибкой - проставьте им режим `Z`, например
`./data:/var/lib:Z`
#
8. Перейдите в веб-интерфейс Chronograf (http://localhost:8888) и откройте вкладку Data explorer.
        
    - Нажмите на кнопку Add a query
    - Изучите вывод интерфейса и выберите БД telegraf.autogen
    - В `measurments` выберите cpu->host->telegraf-getting-started, а в `fields` выберите usage_system. Внизу появится график утилизации cpu.
    - Вверху вы можете увидеть запрос, аналогичный SQL-синтаксису. Поэкспериментируйте с запросом, попробуйте изменить группировку и интервал наблюдений.

Для выполнения задания приведите скриншот с отображением метрик утилизации cpu из веб-интерфейса.
#
9. Изучите список [telegraf inputs](https://github.com/influxdata/telegraf/tree/master/plugins/inputs). 
Добавьте в конфигурацию telegraf следующий плагин - [docker](https://github.com/influxdata/telegraf/tree/master/plugins/inputs/docker):
```
[[inputs.docker]]
  endpoint = "unix:///var/run/docker.sock"
```

Дополнительно вам может потребоваться донастройка контейнера telegraf в `docker-compose.yml` дополнительного volume и 
режима privileged:
```
  telegraf:
    image: telegraf:1.4.0
    privileged: true
    volumes:
      - ./etc/telegraf.conf:/etc/telegraf/telegraf.conf:Z
      - /var/run/docker.sock:/var/run/docker.sock:Z
    links:
      - influxdb
    ports:
      - "8092:8092/udp"
      - "8094:8094"
      - "8125:8125/udp"
```

После настройке перезапустите telegraf, обновите веб интерфейс и приведите скриншотом список `measurments` в 
веб-интерфейсе базы telegraf.autogen . Там должны появиться метрики, связанные с docker.

Факультативно можете изучить какие метрики собирает telegraf после выполнения данного задания.

---

### Решение 1

1. Для данной задачи, необходимо выделить следующие метрики:

- `Network` - состояние сетевых интерфейсов, скорость работы сетевых интерфейсов, количество сетевого трафика, проходящего через сетевой интерфейс. Данные метрики помогут понять, справляются ли с работой сетевые контроллеры сервера.

- `http error codes 400/500` - коды состояния http. Если система доступна по http, значит сервис взаимодействует с конечными пользователями. Данная метрика необходима для информирования клиентов посредством браузеров о статусе выполнения запросов. По ответам кодов можно понять об статусе обработки запросов.

- `CPU load average` - средние значения загрузки ЦПУ, выводится за 1, 5, и 15 минут. Метрика позволяет отслеживать, какие процессы нагружают процессор сервера, показатель поможет контролировать появление и аналитику для устранения проблем производительности.

- `Disk info` - операции чтения/записи для контроля загрузки диска, отображение свободного места на диске, для предотвращения переполнения и остановки сервиса. Эти данные критичны, так как дисковая подсистема может являться узким местом в производительности системы и соответственно негативно влияет на предоставляемый сервис. 

- `Memory Info` - информация об оперативной памяти. Количество используемой и свободной оперативной памяти. Метрика отобразит тяжёлые процессы, нагружаемые память. Также можно добавить величину использования **swap**, так как swap медленнее ОЗУ, использование большого объёма swap замедляет работу предоставляемого сервиса.

---

2. Пояснительные метрики для менеджера:

- `RAM` - оперативная память. Может быть множество показателей работы оперативной памяти, такие как общее количество, доступное количество, скорость ее работы и другое. Постоянно загруженная память более 75% будет давать повод к анализу причин на данном сервере, и увеличение памяти в случае естественного роста нагрузки на сервис для снижения рисков замедления работы сервера.

- `inodes` - индексный дескриптор - это структура данных в которой хранится информация о файле или директории в файловой системе. Каждый файл на диске содержит свой inode, который содержит информацию о размещении этого файла на диске, дате создания, размере, правах доступа. Количество inodes в файловой системе ограничено, поэтому при создании большого количества маленьких файлов, может возникнуть исчерпания inodes, хотя место на диске все ещё может быть доступным. Для решения этой проблемы может потребоваться изменение настроек файловой системы диска.

- `CPUla` - Load Average, средняя загрузка ЦП. Определяет на сколько процессор справляется с работой. При скачкообразных метриках, необходим анализ для понимания причин и возможности их устранения. При естественном росте нагрузки, необходимо рассматривать увеличения количества ядер.

Для того, чтобы понять, насколько компания выполняет свои обязанности перед клиентами и какое качество обслуживания предоставляет нужно рассмотреть возможность сбора и визуализации дополнительных метрик мониторинга, доступность самих сервисов для быстрого реагирования, нагрузки баз данных самих сервисов, чтобы видеть время ответа на запросы и вовремя на них реагировать. Мониторинг срока действия **SSL** сертификатов полезная метрика, порой выпуск может затянуться на рабочую неделю со всеми процедурами подтверждения домена имеющегося сервиса, и для исключения ситуаций недоступности сервиса по **https**, метрика истечения срока достаточно критичная метрика.

---

3. Сбор логов для анализа ошибок приложения в практиках DevOps:

Cистемf сбора и визуализации логов как кластер ELK, сервис позволяет лобирать и визуализировать логи, или же связку Grafana Loki для сбора логов + Grafana для визуализации, в дополнение можно рассмотреть связку Prometheus для сбора логов + Grafana для визуализации. Програмный продукт Sentry поможет перехватывать ошибки приложений. 

Далее сделать выведение алертов по **e-mail** или на график на мониторы, если таковые имеются.

---

4. В формуле не учитываются запросы перенаправлений соединений, которые идут с **3xx** кодами. \
   Формула должна быть: `(summ_2xx_requests+summ_3xx_requests)/summ_all_requests`

---

5. Плюсы и минусы Push и Pull систем мониторинга:

**Push системы - плюсы:**

- Система мониторинга отображает информацию оперативно, так как данные передаются в режиме реального времени. Это особенно важно для критически важных систем, где даже кратковременная задержка может иметь последствия для бизнеса.

- Настройка точек приёма метрик осуществляется на агентах, что позволяет настроить вывод метрик в несколько систем мониторинга.

- Гибкость настройки системы мониторинга, можно выбирать какие данные и как часто отправлять.

- Отправка осуществляется по UDP, поэтому потребляет меньше сетевых ресурсов, размер пакетов меньше.

- Работает за NAT.

**Push системы - минусы:**

- В связи с постоянной передачей данных на сервер мониторинга, значительно вырастает нагрузка на сеть. Это может вызывать проблемы с пропускной способностью сети.

- Требуется установка агента на узлах

- При отправке по UDP могут теряться часть данных

**Pull системы - плюсы:**

- Система мониторинг запрашивает данные только тогда, когда это необходимо. Это помогает снизить нагрузку на сеть.

- Единая точка контроля, так как весь процесс мониторинга и получение данных осуществляется на сервере мониторинга, что в свою очередь упрощает настройку и обслуживание.

**Pull системы - минусы:**

- Данные получаются только после того, как система мониторинга запросит их у устройств или приложений. Это может затруднить моментальную реакцию на проблемы и отсрочить их решение.

- Не работает за NAT.

---

6. Push / Pull

- **Prometheus** - использует **pull** модель, получает данные с экспортеров, которые установлены на хосты внесённые под контроль системы
- **TICK** - использует **push** модель, так как **Telegraf** активно собирает метрики и отправляет их в **InfluxDB**.
- **Zabbix** - использует гибридную модель, может принимать данные от своих агентов, в то же время и отправляет запросы, чтобы проверить доступность узлов.
- **VictoriaMetrics** - использует гибридную модель, система может принимать данные с экспортеров, а также запрашивать данные из других систем мониторинга.
- **Nagios** - использует гибридную модель, **pull** модель используется по умолчанию, но может быть настроен push режим работы.

